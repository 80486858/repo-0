#!/usr/bin/env bash

# fail hard
set -o pipefail
# fail harder
set -eu

bp_dir=$(cd $(dirname $0)/..; pwd) # absolute path
target_dir="${bp_dir}/target"
layers_dir="${1:?}"
platform_dir="${2:?}"

# create a shim cache layer
cache_dir="${layers_dir}/shim"
mkdir -p "${cache_dir}"
echo "cache = true" > ${layers_dir}/shim.toml

"${target_dir}/bin/compile" "$(pwd)" "${cache_dir}" "${platform_dir}/env"

# copy profile.d scripts into a layer so they will be sourced
profile_dir="${layers_dir}/profile"
mkdir -p "${profile_dir}/profile.d"
cp .profile.d/* "${profile_dir}/profile.d/"
echo "launch = true" > ${layers_dir}/profile.toml

if [ -f "${target_dir}/export" ]; then
	echo "build = true" >> ${layers_dir}/profile.toml
	mkdir -p "${profile_dir}/profile.d/env.build/"
	"${bp_dir}/bin/exports" "${target_dir}/export" "${platform_dir}"
	ls -al "${profile_dir}/profile.d/env.build/"
	cat "${profile_dir}/profile.d/env.build/PATH"
#	else
#	echo "bp_dir:"
#	find ${bp_dir} -name export
#	echo "target_dir:"
#	find ${target_dir} -name export
#	echo "pwd:"
#	find $(pwd) -name export
#	exit 1
fi

# run bin/release, read Procfile, and generate launch.toml
"${bp_dir}/bin/release" "${target_dir}" "${layers_dir}" "${platform_dir}"
